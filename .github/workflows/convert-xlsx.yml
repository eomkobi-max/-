name: Convert XLSX to CSV/Parquet
on:
  workflow_dispatch:
  push:
    paths:
      - "data/**/*.xlsx"

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install pandas pyarrow openpyxl
      - name: Convert all .xlsx under data/
        run: |
          python - << 'PY'
          import os, json, pandas as pd, pyarrow as pa, pyarrow.parquet as pq
          from pathlib import Path
          ROOT = Path("data")
          OUT = Path("converted")
          OUT.mkdir(exist_ok=True, parents=True)
          manifest = []

          for xlsx in ROOT.rglob("*.xlsx"):
              book = pd.read_excel(xlsx, sheet_name=None, dtype=str)
              for sname, df in book.items():
                  safe = "".join(c if c.isalnum() or c in "-_." else "_" for c in sname)[:80]
                  base = OUT / f"{xlsx.stem}__{safe}"
                  csv = base.with_suffix(".csv")
                  df.to_csv(csv, index=False, encoding="utf-8-sig")
                  pq.write_table(pa.Table.from_pandas(df), base.with_suffix(".parquet"), compression="snappy")
                  manifest.append({"xlsx": str(xlsx), "sheet": sname, "csv": str(csv), "parquet": str(base.with_suffix(".parquet"))})
          (OUT / "manifest.json").write_text(json.dumps(manifest, ensure_ascii=False, indent=2), encoding="utf-8")
          print("변환 완료:", len(manifest), "sheet")
          PY
      - name: Zip outputs
        run: |
          cd converted
          zip -r ../converted_csv_parquet.zip .
      - uses: actions/upload-artifact@v4
        with:
          name: converted_csv_parquet
          path: converted_csv_parquet.zip

